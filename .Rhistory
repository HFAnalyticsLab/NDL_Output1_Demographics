filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")
filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")
sum(filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")$interaction_rate_v2)
142/1226
ggplot(age_imd_data_full,
aes(x=factor(var1.level),
y = interaction_rate_v2,
fill=factor(var2.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge")
ggplot(age_imd_data_full,
aes(x=factor(var2.level),
y = interaction_rate_v2,
fill=factor(var1.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge")
age_imd_chart <- ggplot(age_imd_data_full,
aes(x=factor(var2.level),
y = interaction_rate_v2,
fill=factor(var1.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols6,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
windows()
age_imd_chart
age_imd_chart <- ggplot(age_imd_data_full,
aes(x=factor(var2.level),
y = interaction_rate_v2,
fill=factor(var1.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols8,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
windows()
age_imd_chart
cols8 <- brewer.pal(n = 8, name = "BuPu")
age_imd_chart <- ggplot(age_imd_data_full,
aes(x=factor(var2.level),
y = interaction_rate_v2,
fill=factor(var1.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols8,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
windows()
age_imd_chart
brewer.pal(n = 9, name = "BuPu")
brewer.pal(n = 10, name = "BuPu")
cols8 <- brewer.pal(n = 9, name = "BuPu")[2:9]
age_imd_chart <- ggplot(age_imd_data_full,
aes(x=factor(var2.level),
y = interaction_rate_v2,
fill=factor(var1.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols8,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
windows()
age_imd_chart
ggplotly(age_imd_chart, tooltip = "text")
age_imd_chart
ggplotly(age_imd_chart)
windows()
age_imd_chart
ggplotly(age_imd_chart)
library(plotly)
ggplotly(age_imd_chart)
method_addition_data <- filter(allpartners.demographics.clean,Breakdown_Field=="shielding_list_source") %>%
filter(.,Partner=="GrampianAberdeen")
method_addition_chart <- ggplot(method_addition_data,
aes(x=factor(Partner), y = rate_all,fill=factor(Breakdown_Value))) +
geom_bar(stat="identity",position="dodge") +
geom_text(aes(label=paste0(round(rate_all,0),"%"),y=(rate_all+2)),size=6,angle = 45,hjust=0.5,vjust=0,colour="red",position = position_dodge(.9)) +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm")))  +
labs(title="%",y = " ",x="Partner") +
guides(fill=guide_legend(title="Method of addition"))
windows()
method_addition_chart
ggplotly(method_addition_chart)
windows()
age_imd_chart
ggplotly(age_imd_chart)
age_imd_chart <- ggplot(age_imd_data_full,
aes(x=var2.level,
y = interaction_rate_v2,
fill=var1.level)) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols8,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
windows()
age_imd_chart
ggplotly(age_imd_chart)
age_imd_data_full <- filter(allpartners.demographics.clean,Breakdown_Field=="age_band_imd") %>%
filter(.,var1.level %in% c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+"))
age_imd_data_small <- select(age_imd_data_full,Partner,var1,var2,
var1.level,var2.level,rate_all,rate_known,interaction_rate_v1,interaction_rate_v2,n,n_known) %>%
mutate(.,across(where(is.numeric), round, 1))
filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")
sum(filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")$interaction_rate_v2)
cols8 <- brewer.pal(n = 9, name = "BuPu")[2:9]
age_imd_chart <- ggplot(age_imd_data_full,
aes(x=factor(var2.level),
y = interaction_rate_v2,
fill=factor(var1.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols8,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
windows()
age_imd_chart
#Save chart
ggsave(paste0(graphsdir,"age_imd_chart.png"), age_imd_chart, device="png",width = 25, height = 8,dpi=600)
fwrite(age_imd_data_small, file = paste0(graphsdir,"data for charts/age_imd_data_small.csv"), sep = ",")
filter(age_imd_data_full,Partner=="LiverpoolWirral"&var2.level=="1")
filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")
filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")
sum(filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")$interaction_rate_v2)
sum(filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")$interaction_rate_v1)
ggplot(age_imd_data_full,
aes(x=factor(var1.level),
y = interaction_rate_v1,
fill=factor(var2.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge")
ggplot(age_imd_data_full,
aes(x=factor(var1.level),
y = interaction_rate_v1,
fill=factor(var2.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols6,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,plyr,readODS,
gmodels,Rmisc,DescTools,data.table,
Hmisc,tibble,pbapply,pbmcapply,here,
tidyverse,readxl)
#Clean up the global environment
rm(list = ls())
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#Deprivation by LSOA
IMD19_by_LSOA <- fread(paste0(popdatadir,"Other data/","IMD/LSOA/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).csv"), header=TRUE, sep=",", check.names=T) %>%
filter(.,IMDDecil!=0)
IMD19_by_LSOA$IMDQuintile  <- mapvalues(IMD19_by_LSOA$IMDDecil,
from = 1:10,
to = c(1,1,2,2,3,3,4,4,5,5))
#Population
pop_by_LSOA <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Population by age
pop_by_LSOA_ages <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4)
pop_by_LSOA_ages$`pop_0to19` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==0):which(names(pop_by_LSOA_ages)==19)])
pop_by_LSOA_ages$`pop_20to29` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==20):which(names(pop_by_LSOA_ages)==29)])
pop_by_LSOA_ages$`pop_30to39` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==30):which(names(pop_by_LSOA_ages)==39)])
pop_by_LSOA_ages$`pop_40to49` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==40):which(names(pop_by_LSOA_ages)==49)])
pop_by_LSOA_ages$`pop_50to59` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==50):which(names(pop_by_LSOA_ages)==59)])
pop_by_LSOA_ages$`pop_60to69` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==60):which(names(pop_by_LSOA_ages)==69)])
pop_by_LSOA_ages$`pop_70to79` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==70):which(names(pop_by_LSOA_ages)==79)])
pop_by_LSOA_ages$`pop_80plus` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==80):which(names(pop_by_LSOA_ages)=="90+")])
pop_by_LSOA_ages <- select(pop_by_LSOA_ages,`LSOA Code`,starts_with("pop"))
gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE) %>%
mutate(.,ageband=str_replace_all(pop_by_LSOA_ages$ageband,"pop_",""))
pop_by_LSOA_ages
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages
pop_by_LSOA_ages <- gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
pop_by_LSOA_ages
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages
LSOA_to_CCG <- fread(paste0(popdatadir,"Other data/","Lookups/LSOA_(2011)_to_Clinical_Commissioning_Groups_to_Sustainability_and_Transformation_Partnerships_(April_2020)_Lookup_in_England.csv"), header=TRUE, sep=",", check.names=T)
LSOA_to_CCG
pop_by_LSOA_ages
LSOA_to_CCG
pop_by_LSOA_ages
LSOA_to_CCG
LSOA_to_CCG
LiverpoolWirral.bis <- left_join(pop_by_LSOA_ages,LSOA_to_CCG,by=c("`LSOA Code`"="LSOA11CD"))
pop_by_LSOA_ages <- dplyr::rename(pop_by_LSOA_ages,LSOA11CD=`LSOA Code`)
pop_by_LSOA_ages
LSOA_to_CCG
LiverpoolWirral.bis <- left_join(pop_by_LSOA_ages,select(LSOA_to_CCG,"LSOA11CD","CCG20NM"),by="LSOA11CD")
LiverpoolWirral.bis
LiverpoolWirral.bis <- left_join(pop_by_LSOA_ages,select(LSOA_to_CCG,"LSOA11CD","CCG20NM"),by="LSOA11CD") %>%
filter(.,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
LiverpoolWirral.bis
IMD19_by_LSOA
LiverpoolWirral.bis <- left_join(LiverpoolWirral.bis,select(IMD19_by_LSOA,"lsoa11cd","IMDQuintile"))
LiverpoolWirral.bis <- left_join(LiverpoolWirral.bis,select(IMD19_by_LSOA,"lsoa11cd","IMDQuintile"),
by=c("LSOA11CD"="lsoa11cd"))
LiverpoolWirral.bis
sum(LiverpoolWirral.bis$count)
LiverpoolWirral.bis %>%
group_by(.,IMDQuintile,ageband) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral.bis %>%
group_by(.,IMDQuintile,ageband) %>%
summarise(.,pop19 = sum(count)) %>%
ungroup()
LiverpoolWirral.bis %>%
group_by(.,IMDQuintile,ageband) %>%
summarise(.,pop19 = sum(count))
LiverpoolWirral.bis
LiverpoolWirral.bis %>%
group_by(.,ageband) %>%
summarise(.,pop19 = sum(count))
LiverpoolWirral.bis
LiverpoolWirral.bis %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(count))
LiverpoolWirral.bis %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(count))
LiverpoolWirral.bis
LiverpoolWirral
LiverpoolWirral <- filter(LSOA_to_CCG,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
#Merge in population
LiverpoolWirral <- left_join(LiverpoolWirral,pop_by_LSOA,by="LSOA11CD")
filter(LiverpoolWirral,is.na(pop19))
#Merge in deprivation
LiverpoolWirral <- left_join(LiverpoolWirral,select(IMD19_by_LSOA,lsoa11cd,IMDQuintile),
by=c("LSOA11CD"="lsoa11cd"))
LiverpoolWirral
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral
pop_by_LSOA
#Clean up the global environment
rm(list = ls())
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#Deprivation by LSOA
IMD19_by_LSOA <- fread(paste0(popdatadir,"Other data/","IMD/LSOA/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).csv"), header=TRUE, sep=",", check.names=T) %>%
filter(.,IMDDecil!=0)
IMD19_by_LSOA$IMDQuintile  <- mapvalues(IMD19_by_LSOA$IMDDecil,
from = 1:10,
to = c(1,1,2,2,3,3,4,4,5,5))
#Population
pop_by_LSOA <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Population by age
pop_by_LSOA_ages <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4)
#New variables
pop_by_LSOA_ages$`pop_0to19` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==0):which(names(pop_by_LSOA_ages)==19)])
pop_by_LSOA_ages$`pop_20to29` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==20):which(names(pop_by_LSOA_ages)==29)])
pop_by_LSOA_ages$`pop_30to39` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==30):which(names(pop_by_LSOA_ages)==39)])
pop_by_LSOA_ages$`pop_40to49` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==40):which(names(pop_by_LSOA_ages)==49)])
pop_by_LSOA_ages$`pop_50to59` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==50):which(names(pop_by_LSOA_ages)==59)])
pop_by_LSOA_ages$`pop_60to69` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==60):which(names(pop_by_LSOA_ages)==69)])
pop_by_LSOA_ages$`pop_70to79` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==70):which(names(pop_by_LSOA_ages)==79)])
pop_by_LSOA_ages$`pop_80plus` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==80):which(names(pop_by_LSOA_ages)=="90+")])
#Reshape
pop_by_LSOA_ages <- select(pop_by_LSOA_ages,`LSOA Code`,starts_with("pop"))
pop_by_LSOA_ages <- gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages <- dplyr::rename(pop_by_LSOA_ages,LSOA11CD=`LSOA Code`)
#LSOA to CCG
LSOA_to_CCG <- fread(paste0(popdatadir,"Other data/","Lookups/LSOA_(2011)_to_Clinical_Commissioning_Groups_to_Sustainability_and_Transformation_Partnerships_(April_2020)_Lookup_in_England.csv"), header=TRUE, sep=",", check.names=T)
read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Clean up the global environment
rm(list = ls())
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#Deprivation by LSOA
IMD19_by_LSOA <- fread(paste0(popdatadir,"Other data/","IMD/LSOA/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).csv"), header=TRUE, sep=",", check.names=T) %>%
filter(.,IMDDecil!=0)
IMD19_by_LSOA$IMDQuintile  <- mapvalues(IMD19_by_LSOA$IMDDecil,
from = 1:10,
to = c(1,1,2,2,3,3,4,4,5,5))
#Population
pop_by_LSOA <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
dplyr::rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Population by age
pop_by_LSOA_ages <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4)
#New variables
pop_by_LSOA_ages$`pop_0to19` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==0):which(names(pop_by_LSOA_ages)==19)])
pop_by_LSOA_ages$`pop_20to29` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==20):which(names(pop_by_LSOA_ages)==29)])
pop_by_LSOA_ages$`pop_30to39` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==30):which(names(pop_by_LSOA_ages)==39)])
pop_by_LSOA_ages$`pop_40to49` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==40):which(names(pop_by_LSOA_ages)==49)])
pop_by_LSOA_ages$`pop_50to59` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==50):which(names(pop_by_LSOA_ages)==59)])
pop_by_LSOA_ages$`pop_60to69` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==60):which(names(pop_by_LSOA_ages)==69)])
pop_by_LSOA_ages$`pop_70to79` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==70):which(names(pop_by_LSOA_ages)==79)])
pop_by_LSOA_ages$`pop_80plus` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==80):which(names(pop_by_LSOA_ages)=="90+")])
#Reshape
pop_by_LSOA_ages <- select(pop_by_LSOA_ages,`LSOA Code`,starts_with("pop"))
pop_by_LSOA_ages <- gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages <- dplyr::rename(pop_by_LSOA_ages,LSOA11CD=`LSOA Code`)
#LSOA to CCG
LSOA_to_CCG <- fread(paste0(popdatadir,"Other data/","Lookups/LSOA_(2011)_to_Clinical_Commissioning_Groups_to_Sustainability_and_Transformation_Partnerships_(April_2020)_Lookup_in_England.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral <- filter(LSOA_to_CCG,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
#Merge in population
LiverpoolWirral <- left_join(LiverpoolWirral,pop_by_LSOA,by="LSOA11CD")
filter(LiverpoolWirral,is.na(pop19))
#Merge in deprivation
LiverpoolWirral <- left_join(LiverpoolWirral,select(IMD19_by_LSOA,lsoa11cd,IMDQuintile),
by=c("LSOA11CD"="lsoa11cd"))
filter(LiverpoolWirral,is.na(IMDQuintile))
LiverpoolWirral
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral
LiverpoolWirral_depquint <- LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup() %>%
mutate(.,pop19_total=sum(LiverpoolWirral$pop19)) %>%
mutate(rate=pop19/pop19_total*100)
LiverpoolWirral_depquint
LiverpoolWirral
LiverpoolWirral <- as.data.frame(LiverpoolWirral)
LiverpoolWirral
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,readODS,
gmodels,Rmisc,DescTools,data.table,
Hmisc,tibble,pbapply,pbmcapply,here,
tidyverse,readxl)
#Clean up the global environment
rm(list = ls())
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#Deprivation by LSOA
IMD19_by_LSOA <- fread(paste0(popdatadir,"Other data/","IMD/LSOA/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).csv"), header=TRUE, sep=",", check.names=T) %>%
filter(.,IMDDecil!=0)
IMD19_by_LSOA$IMDQuintile  <- mapvalues(IMD19_by_LSOA$IMDDecil,
from = 1:10,
to = c(1,1,2,2,3,3,4,4,5,5))
#Population
pop_by_LSOA <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
dplyr::rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Population by age
pop_by_LSOA_ages <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4)
#New variables
pop_by_LSOA_ages$`pop_0to19` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==0):which(names(pop_by_LSOA_ages)==19)])
pop_by_LSOA_ages$`pop_20to29` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==20):which(names(pop_by_LSOA_ages)==29)])
pop_by_LSOA_ages$`pop_30to39` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==30):which(names(pop_by_LSOA_ages)==39)])
pop_by_LSOA_ages$`pop_40to49` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==40):which(names(pop_by_LSOA_ages)==49)])
pop_by_LSOA_ages$`pop_50to59` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==50):which(names(pop_by_LSOA_ages)==59)])
pop_by_LSOA_ages$`pop_60to69` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==60):which(names(pop_by_LSOA_ages)==69)])
pop_by_LSOA_ages$`pop_70to79` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==70):which(names(pop_by_LSOA_ages)==79)])
pop_by_LSOA_ages$`pop_80plus` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==80):which(names(pop_by_LSOA_ages)=="90+")])
#Reshape
pop_by_LSOA_ages <- select(pop_by_LSOA_ages,`LSOA Code`,starts_with("pop"))
pop_by_LSOA_ages <- gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages <- dplyr::rename(pop_by_LSOA_ages,LSOA11CD=`LSOA Code`)
#LSOA to CCG
LSOA_to_CCG <- fread(paste0(popdatadir,"Other data/","Lookups/LSOA_(2011)_to_Clinical_Commissioning_Groups_to_Sustainability_and_Transformation_Partnerships_(April_2020)_Lookup_in_England.csv"), header=TRUE, sep=",", check.names=T)
############################################################################
################### Deprivation distr. in Liverpool-Wirral #################
############################################################################
LiverpoolWirral <- filter(LSOA_to_CCG,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
#Merge in population
LiverpoolWirral <- left_join(LiverpoolWirral,pop_by_LSOA,by="LSOA11CD")
filter(LiverpoolWirral,is.na(pop19))
#Merge in deprivation
LiverpoolWirral <- left_join(LiverpoolWirral,select(IMD19_by_LSOA,lsoa11cd,IMDQuintile),
by=c("LSOA11CD"="lsoa11cd"))
filter(LiverpoolWirral,is.na(IMDQuintile))
LiverpoolWirral_depquint <- LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup() %>%
mutate(.,pop19_total=sum(LiverpoolWirral$pop19)) %>%
mutate(rate=pop19/pop19_total*100)
LiverpoolWirral_depquint
LiverpoolWirral.bis
LiverpoolWirral
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
detach(package:plyr)
