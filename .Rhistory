rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#SPL
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Population
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
############################################
################### IMPORT #################
############################################
all_partners <- read_excel(paste0(rawdatadir,"allpartners-demographics.xlsx"),
sheet = 1)
all_partners
filter(all_partners,interaction==1)
filter(all_partners,interaction==1) %>% select(.,Breakdown_Field) %>% unique()
filter(all_partners,Breakdown_Field=="age_band_imd")
filter(all_partners,Breakdown_Field=="age_band_imd"&Partner=="GrampianAberdeen") %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n)
all_partners
filter(all_partners,Breakdown_Field=="age_band_imd"&Partner=="GrampianAberdeen") %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n)
filter(all_partners,Breakdown_Field=="age_band"&Partner=="GrampianAberdeen") %>%
select(.,Partner,Breakdown_Field,Breakdown_Value,Count)
all_partners <- read_excel(paste0(rawdatadir,"allpartners-demographics.xlsx"),
sheet = 1)
all_partners
filter(all_partners,Breakdown_Field=="age_band_imd"&Partner=="GrampianAberdeen") %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n.old,var2.n.old)
filter(all_partners,interaction==0)
filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count")
aux.totals <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
rename(.,var1.n=Count)
filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var1.n=Count)
all_partners
aux.totals.one <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var1=Breakdown_Field,var1.level=Breakdown_Value,var1.n=Count)
aux.totals.one
aux.totals.two <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var2=Breakdown_Field,var2.level=Breakdown_Value,var2.n=Count)
aux.totals.two
all_partners <- left_join(all_partners,aux.totals.one,by=c("Partner","var1","var1.level"))
all_partners
filter(all_partners,Breakdown_Field=="age_band_imd"&Partner=="GrampianAberdeen") %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n.old,var2.n.old)
filter(all_partners,Breakdown_Field=="age_band_imd"&Partner=="GrampianAberdeen") %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n,
var1.n.old,var2.n.old)
filter(all_partners,Breakdown_Field=="age_band_imd"&Partner=="GrampianAberdeen") %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,
var1.n.old,var2.n.old)
all_partners <- read_excel(paste0(rawdatadir,"allpartners-demographics.xlsx"),
sheet = 1)
#####################################################################
################### Merge in totals for interaction #################
#####################################################################
#Merge var.1level to
aux.totals.one <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var1=Breakdown_Field,var1.level=Breakdown_Value,var1.n=Count)
aux.totals.two <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var2=Breakdown_Field,var2.level=Breakdown_Value,var2.n=Count)
all_partners <- left_join(all_partners,aux.totals.one,by=c("Partner","var1","var1.level")) %>%
left_join(.,by=c("Partner","var2","var2.level"))
all_partners <- read_excel(paste0(rawdatadir,"allpartners-demographics.xlsx"),
sheet = 1)
#####################################################################
################### Merge in totals for interaction #################
#####################################################################
#Merge var.1level to
aux.totals.one <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var1=Breakdown_Field,var1.level=Breakdown_Value,var1.n=Count)
aux.totals.two <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var2=Breakdown_Field,var2.level=Breakdown_Value,var2.n=Count)
all_partners <- left_join(all_partners,aux.totals.one,by=c("Partner","var1","var1.level")) %>%
left_join(.,aux.totals.two,by=c("Partner","var2","var2.level"))
filter(all_partners,Breakdown_Field=="age_band_imd"&Partner=="GrampianAberdeen") %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n,
var1.n.old,var2.n.old)
filter(all_partners,(var1.n!=var1.n.old)|(var2.n!=var2.n.old)) %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n,
var1.n.old,var2.n.old)
all_partners <- read_excel(paste0(rawdatadir,"allpartners-demographics.xlsx"),
sheet = 1)
#####################################################################
################### Merge in totals for interaction #################
#####################################################################
#Merge var.1level to
aux.totals.one <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var1=Breakdown_Field,var1.level=Breakdown_Value,var1.n=Count)
aux.totals.two <- filter(all_partners,interaction==0) %>%
select(.,"Partner","Breakdown_Field","Breakdown_Value","Count") %>%
dplyr::rename(.,var2=Breakdown_Field,var2.level=Breakdown_Value,var2.n=Count)
all_partners <- left_join(all_partners,aux.totals.one,by=c("Partner","var1","var1.level")) %>%
left_join(.,aux.totals.two,by=c("Partner","var2","var2.level"))
filter(all_partners,(var1.n!=var1.n.old)|(var2.n!=var2.n.old)) %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n,
var1.n.old,var2.n.old)
filter(all_partners,(var1.n!=var1.n.old)|(var2.n!=var2.n.old)) %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n,
var1.n.old,var2.n.old)
aux.totals.one
filter(all_partners,interaction==0) %>%
select(.,Partner,var1,var2,var1.level,var2.level,var1.n,var2.n)
filter(all_partners,interaction==0) %>%
select(.,Partner,Breakdown_Field,var1,var2,var1.level,var2.level,var1.n,var2.n)
#Clean up the global environment
rm(list = ls())
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
##################################################
################### Load clean data ##############
##################################################
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint <- fread(paste0(rawdatadir,"opendata-demographics-interactions.csv"), header=TRUE, sep=",", check.names=T)
allpartners.demographics.clean %>% filter(.,Partner=="GrampianAberdeen") %>% select(.,n) %>% min(.,na.rm=TRUE)
#Clean up the global environment
rm(list = ls())
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
##################################################
################### Load clean data ##############
##################################################
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint <- fread(paste0(rawdatadir,"opendata-demographics-interactions.csv"), header=TRUE, sep=",", check.names=T)
###############################################
################### Shielding rate ############
###############################################
#Liverpool-Wirral
pop_liverpool_wirral <- pop_by_CCG %>% filter(., `CCG Name` %in% c("NHS Liverpool CCG","NHS Wirral CCG")) %>%
select(.,`All Ages`) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_opendata <- SPL_by_CCG %>% filter(.,Breakdown.Field=="ALL"&(CCG.Name %in% c("NHS Liverpool CCG","NHS Wirral CCG"))) %>%
select(.,Patient.Count) %>% mutate(.,Patient.Count=as.numeric(Patient.Count)) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_NDL <- allpartners.demographics.clean %>% filter(.,Partner=="LiverpoolWirral") %>% select(.,n) %>% min(.,na.rm=TRUE)
pct_shielding_liverpool_wirral_opendata <- pop_shielding_liverpool_wirral_opendata/pop_liverpool_wirral*100
#Grampian-Aberdeen
pop_grampian <- pop_by_scottish_board %>% filter(., `NHS Board areas` %in% c("Grampian")) %>%
select(.,`...3`) %>% as.numeric()
pop_shielding_grampian_NDL <- 14773
pct_shielding_grampian_NDL <- pop_shielding_grampian_NDL/pop_grampian*100
pct_shielding_grampian_NDL
pop_grampian
pop_shielding_grampian_NDL
pop_shielding_grampian_NDL/pop_grampian*100
rate_by_partner_chart_data
#Chart data
rate_by_partner_chart_data <- rbind.data.frame(
c("Liverpool-Wirral",pct_shielding_liverpool_wirral_opendata,pop_shielding_liverpool_wirral_opendata,pop_liverpool_wirral),
c("North West England",filter(SPL_by_GOR_wEng,RGN19NM=="North West")$Shielders_pct,sum(filter(SPL_by_LA_All,RGN19NM=="North West")$Patient.Count),filter(pop_by_LA,LAD19NM=="NORTH WEST")$pop19),
c("England",filter(SPL_by_GOR_wEng,RGN19NM=="England")$Shielders_pct,filter(SPL_by_LA_All_incl_ENG,LA.Name=="ENGLAND")$Patient.Count,filter(pop_by_LA,LAD19NM=="ENGLAND")$pop19),
c("Grampian",pct_shielding_grampian_NDL,pop_shielding_grampian_NDL,pop_grampian),
c("Scotland",filter(SPL_by_GOR_wEng,RGN19NM=="Scotland")$Shielders_pct,179997,filter(pop_by_LA,LAD19NM=="SCOTLAND")$pop19)
)
names(rate_by_partner_chart_data) <- c("Location","Rate","numerator","denominator")
rate_by_partner_chart_data <- rate_by_partner_chart_data %>%
arrange(.,desc(Rate)) %>%
mutate(.,Rate=as.numeric(Rate))
#Clean up the global environment
rm(list = ls())
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
##################################################
################### Load clean data ##############
##################################################
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint <- fread(paste0(rawdatadir,"opendata-demographics-interactions.csv"), header=TRUE, sep=",", check.names=T)
###############################################
################### Shielding rate ############
###############################################
#Liverpool-Wirral
pop_liverpool_wirral <- pop_by_CCG %>% filter(., `CCG Name` %in% c("NHS Liverpool CCG","NHS Wirral CCG")) %>%
select(.,`All Ages`) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_opendata <- SPL_by_CCG %>% filter(.,Breakdown.Field=="ALL"&(CCG.Name %in% c("NHS Liverpool CCG","NHS Wirral CCG"))) %>%
select(.,Patient.Count) %>% mutate(.,Patient.Count=as.numeric(Patient.Count)) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_NDL <- allpartners.demographics.clean %>% filter(.,Partner=="LiverpoolWirral") %>% select(.,n) %>% min(.,na.rm=TRUE)
pct_shielding_liverpool_wirral_opendata <- pop_shielding_liverpool_wirral_opendata/pop_liverpool_wirral*100
#Grampian-Aberdeen
pop_grampian <- pop_by_scottish_board %>% filter(., `NHS Board areas` %in% c("Grampian")) %>%
select(.,`...3`) %>% as.numeric()
pop_shielding_grampian_NDL <- 14773
pct_shielding_grampian_NDL <- pop_shielding_grampian_NDL/pop_grampian*100
#Chart data
rate_by_partner_chart_data <- rbind.data.frame(
c("Liverpool-Wirral",pct_shielding_liverpool_wirral_opendata,pop_shielding_liverpool_wirral_opendata,pop_liverpool_wirral),
c("North West England",filter(SPL_by_GOR_wEng,RGN19NM=="North West")$Shielders_pct,sum(filter(SPL_by_LA_All,RGN19NM=="North West")$Patient.Count),filter(pop_by_LA,LAD19NM=="NORTH WEST")$pop19),
c("England",filter(SPL_by_GOR_wEng,RGN19NM=="England")$Shielders_pct,filter(SPL_by_LA_All_incl_ENG,LA.Name=="ENGLAND")$Patient.Count,filter(pop_by_LA,LAD19NM=="ENGLAND")$pop19),
c("Grampian",pct_shielding_grampian_NDL,pop_shielding_grampian_NDL,pop_grampian),
c("Scotland",filter(SPL_by_GOR_wEng,RGN19NM=="Scotland")$Shielders_pct,179997,filter(pop_by_LA,LAD19NM=="SCOTLAND")$pop19)
)
names(rate_by_partner_chart_data) <- c("Location","Rate","numerator","denominator")
rate_by_partner_chart_data <- rate_by_partner_chart_data %>%
arrange(.,desc(Rate)) %>%
mutate(.,Rate=as.numeric(Rate))
SPL_by_GOR_wEng
filter(SPL_by_GOR_wEng,RGN19NM=="North West")
filter(SPL_by_LA_All,RGN19NM=="North West")
SPL_by_LA_All
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,plyr,readODS,
gmodels,Rmisc,DescTools,data.table,readxl,
Hmisc,tibble,leaflet,rgeos,raster,plotly,
pbapply,pbmcapply,here,rgdal,RColorBrewer,ggthemes,
ggchicklet,tidyverse,showtext,ggchicklet)
#Clean up the global environment
rm(list = ls())
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
##################################################
################### Load clean data ##############
##################################################
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint <- fread(paste0(rawdatadir,"opendata-demographics-interactions.csv"), header=TRUE, sep=",", check.names=T)
###############################################
################### Shielding rate ############
###############################################
#Liverpool-Wirral
pop_liverpool_wirral <- pop_by_CCG %>% filter(., `CCG Name` %in% c("NHS Liverpool CCG","NHS Wirral CCG")) %>%
select(.,`All Ages`) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_opendata <- SPL_by_CCG %>% filter(.,Breakdown.Field=="ALL"&(CCG.Name %in% c("NHS Liverpool CCG","NHS Wirral CCG"))) %>%
select(.,Patient.Count) %>% mutate(.,Patient.Count=as.numeric(Patient.Count)) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_NDL <- allpartners.demographics.clean %>% filter(.,Partner=="LiverpoolWirral") %>% select(.,n) %>% min(.,na.rm=TRUE)
pct_shielding_liverpool_wirral_opendata <- pop_shielding_liverpool_wirral_opendata/pop_liverpool_wirral*100
#Grampian-Aberdeen
pop_grampian <- pop_by_scottish_board %>% filter(., `NHS Board areas` %in% c("Grampian")) %>%
select(.,`...3`) %>% as.numeric()
pop_shielding_grampian_NDL <- 14773
pct_shielding_grampian_NDL <- pop_shielding_grampian_NDL/pop_grampian*100
#Chart data
rate_by_partner_chart_data <- rbind.data.frame(
c("Liverpool-Wirral",pct_shielding_liverpool_wirral_opendata,pop_shielding_liverpool_wirral_opendata,pop_liverpool_wirral),
c("North West England",filter(SPL_by_GOR_wEng,RGN19NM=="North West")$Shielders_pct,sum(filter(SPL_by_LA_All,RGN19NM=="North West")$Patient.Count),filter(pop_by_LA,LAD19NM=="NORTH WEST")$pop19),
c("England",filter(SPL_by_GOR_wEng,RGN19NM=="England")$Shielders_pct,filter(SPL_by_LA_All_incl_ENG,LA.Name=="ENGLAND")$Patient.Count,filter(pop_by_LA,LAD19NM=="ENGLAND")$pop19),
c("Grampian",pct_shielding_grampian_NDL,pop_shielding_grampian_NDL,pop_grampian),
c("Scotland",filter(SPL_by_GOR_wEng,RGN19NM=="Scotland")$Shielders_pct,179997,filter(pop_by_LA,LAD19NM=="SCOTLAND")$pop19)
)
names(rate_by_partner_chart_data) <- c("Location","Rate","numerator","denominator")
rate_by_partner_chart_data
knitr::opts_chunk$set(echo = TRUE)
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,plyr,readODS,
gmodels,Rmisc,DescTools,data.table,
Hmisc,tibble,leaflet,rgeos,raster,plotly,
pbapply,pbmcapply,here,rgdal,RColorBrewer,ggthemes,
ggchicklet,tidyverse,showtext,ggchicklet,readxl)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint <- fread(paste0(rawdatadir,"opendata-demographics-interactions.csv"), header=TRUE, sep=",", check.names=T)
#Liverpool-Wirral
pop_liverpool_wirral <- pop_by_CCG %>% filter(., `CCG Name` %in% c("NHS Liverpool CCG","NHS Wirral CCG")) %>%
select(.,`All Ages`) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_opendata <- SPL_by_CCG %>% filter(.,Breakdown.Field=="ALL"&(CCG.Name %in% c("NHS Liverpool CCG","NHS Wirral CCG"))) %>%
select(.,Patient.Count) %>% mutate(.,Patient.Count=as.numeric(Patient.Count)) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_NDL <- allpartners.demographics.clean %>% filter(.,Partner=="LiverpoolWirral") %>% select(.,n) %>% min(.,na.rm=TRUE)
pct_shielding_liverpool_wirral_opendata <- pop_shielding_liverpool_wirral_opendata/pop_liverpool_wirral*100
#Grampian-Aberdeen
pop_grampian <- pop_by_scottish_board %>% filter(., `NHS Board areas` %in% c("Grampian")) %>%
select(.,`...3`) %>% as.numeric()
pop_shielding_grampian_NDL <- allpartners.demographics.clean %>% filter(.,Partner=="GrampianAberdeen") %>% select(.,n) %>% min(.,na.rm=TRUE)
pct_shielding_grampian_NDL <- pop_shielding_grampian_NDL/pop_grampian*100
#Chart data
rate_by_partner_chart_data <- rbind.data.frame(
c("Liverpool-Wirral",pct_shielding_liverpool_wirral_opendata,pop_shielding_liverpool_wirral_opendata,pop_liverpool_wirral),
c("North West England",filter(SPL_by_GOR_wEng,RGN19NM=="North West")$Shielders_pct,sum(filter(SPL_by_LA_All,RGN19NM=="North West")$Patient.Count),filter(pop_by_LA,LAD19NM=="NORTH WEST")$pop19),
c("England",filter(SPL_by_GOR_wEng,RGN19NM=="England")$Shielders_pct,filter(SPL_by_LA_All_incl_ENG,LA.Name=="ENGLAND")$Patient.Count,filter(pop_by_LA,LAD19NM=="ENGLAND")$pop19),
c("Grampian",pct_shielding_grampian_NDL,pop_shielding_grampian_NDL,pop_grampian),
c("Scotland",filter(SPL_by_GOR_wEng,RGN19NM=="Scotland")$Shielders_pct,179997,filter(pop_by_LA,LAD19NM=="SCOTLAND")$pop19)
)
names(rate_by_partner_chart_data) <- c("Location","Rate","numerator","denominator")
rate_by_partner_chart_data <- rate_by_partner_chart_data %>%
arrange(.,desc(Rate)) %>%
mutate(.,Rate=as.numeric(Rate))
#Chart
rate_by_partner_chart <- ggplot(rate_by_partner_chart_data) +
geom_bar(aes(x=reorder(Location,Rate), y = round(Rate,1)),
fill = "firebrick",stat='identity') +
geom_text(aes(x = Location, y = Rate + 0.3,
label = paste0(round(Rate, 1),"%")),
size=4) +
theme(axis.title.x = element_blank(),
panel.border = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x=element_text(angle=45, hjust=1),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
panel.background = element_blank(),
text = element_text(size = 10)) +
labs(title="% residents shielding",y = " ",x="")
ggplotly(rate_by_partner_chart)
#Liverpool-Wirral
pop_liverpool_wirral <- pop_by_CCG %>% filter(., `CCG Name` %in% c("NHS Liverpool CCG","NHS Wirral CCG")) %>%
select(.,`All Ages`) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_opendata <- SPL_by_CCG %>% filter(.,Breakdown.Field=="ALL"&(CCG.Name %in% c("NHS Liverpool CCG","NHS Wirral CCG"))) %>%
select(.,Patient.Count) %>% mutate(.,Patient.Count=as.numeric(Patient.Count)) %>% sum(.,na.rm=TRUE)
pop_shielding_liverpool_wirral_NDL <- allpartners.demographics.clean %>% filter(.,Partner=="LiverpoolWirral") %>% select(.,n) %>% min(.,na.rm=TRUE)
pct_shielding_liverpool_wirral_opendata <- pop_shielding_liverpool_wirral_opendata/pop_liverpool_wirral*100
#Grampian-Aberdeen
pop_grampian <- pop_by_scottish_board %>% filter(., `NHS Board areas` %in% c("Grampian")) %>%
select(.,`...3`) %>% as.numeric()
pop_shielding_grampian_NDL <- 14773
pct_shielding_grampian_NDL <- pop_shielding_grampian_NDL/pop_grampian*100
#Chart data
rate_by_partner_chart_data <- rbind.data.frame(
c("Liverpool-Wirral",pct_shielding_liverpool_wirral_opendata,pop_shielding_liverpool_wirral_opendata,pop_liverpool_wirral),
c("North West England",filter(SPL_by_GOR_wEng,RGN19NM=="North West")$Shielders_pct,sum(filter(SPL_by_LA_All,RGN19NM=="North West")$Patient.Count),filter(pop_by_LA,LAD19NM=="NORTH WEST")$pop19),
c("England",filter(SPL_by_GOR_wEng,RGN19NM=="England")$Shielders_pct,filter(SPL_by_LA_All_incl_ENG,LA.Name=="ENGLAND")$Patient.Count,filter(pop_by_LA,LAD19NM=="ENGLAND")$pop19),
c("Grampian",pct_shielding_grampian_NDL,pop_shielding_grampian_NDL,pop_grampian),
c("Scotland",filter(SPL_by_GOR_wEng,RGN19NM=="Scotland")$Shielders_pct,179997,filter(pop_by_LA,LAD19NM=="SCOTLAND")$pop19)
)
names(rate_by_partner_chart_data) <- c("Location","Rate","numerator","denominator")
rate_by_partner_chart_data <- rate_by_partner_chart_data %>%
arrange(.,desc(Rate)) %>%
mutate(.,Rate=as.numeric(Rate))
#Chart
rate_by_partner_chart <- ggplot(rate_by_partner_chart_data) +
geom_bar(aes(x=reorder(Location,Rate), y = round(Rate,1)),
fill = "firebrick",stat='identity') +
geom_text(aes(x = Location, y = Rate + 0.3,
label = paste0(round(Rate, 1),"%")),
size=4) +
theme(axis.title.x = element_blank(),
panel.border = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x=element_text(angle=45, hjust=1),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
panel.background = element_blank(),
text = element_text(size = 10)) +
labs(title="% residents shielding",y = " ",x="")
ggplotly(rate_by_partner_chart)
urbanrural_data_full
urbanrural_data_full <- filter(allpartners.demographics.clean,Breakdown_Field=="urbanrural")
urbanrural_data_full
age_imd_data_full <- filter(allpartners.demographics.clean,Breakdown_Field=="age_band_imd") %>%
filter(.,var1.level %in% c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")) %>%
filter(.,!(var2.level=="unknown"&Partner=="LiverpoolWirral"))
age_imd_data_small <- select(age_imd_data_full,Partner,var1,var2,
var1.level,var2.level,rate_all,rate_known,interaction_rate_v1,interaction_rate_v2,n,n_known) %>%
mutate(.,across(where(is.numeric), round, 1))
sum(filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")$interaction_rate_v2)
age_imd_data_full <- filter(allpartners.demographics.clean,Breakdown_Field=="age_band_imd") %>%
filter(.,var1.level %in% c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+"))
age_imd_data_small <- select(age_imd_data_full,Partner,var1,var2,
var1.level,var2.level,rate_all,rate_known,interaction_rate_v1,interaction_rate_v2,n,n_known) %>%
mutate(.,across(where(is.numeric), round, 1))
cols6 <- c(brewer.pal(n = 5, name = "RdYlGn"),"#bdbdbd")
sum(filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")$interaction_rate_v1)
sum(filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")$interaction_rate_v1)
filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")
sum(filter(age_imd_data_full,Partner=="LiverpoolWirral"&var1.level=="80+")$interaction_rate_v1)
filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")
filter(age_imd_data_full,Partner=="LiverpoolWirral"&var2.level=="unknown")
sum(filter(age_imd_data_full,Partner=="GrampianAberdeen"&var2.level=="1")$interaction_rate_v2)
