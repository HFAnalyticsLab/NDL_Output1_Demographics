group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral
LiverpoolWirral_depquint <- LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup() %>%
mutate(.,pop19_total=sum(LiverpoolWirral$pop19)) %>%
mutate(rate=pop19/pop19_total*100)
LiverpoolWirral_depquint
LiverpoolWirral
LiverpoolWirral <- as.data.frame(LiverpoolWirral)
LiverpoolWirral
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,readODS,
gmodels,Rmisc,DescTools,data.table,
Hmisc,tibble,pbapply,pbmcapply,here,
tidyverse,readxl)
#Clean up the global environment
rm(list = ls())
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#Deprivation by LSOA
IMD19_by_LSOA <- fread(paste0(popdatadir,"Other data/","IMD/LSOA/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).csv"), header=TRUE, sep=",", check.names=T) %>%
filter(.,IMDDecil!=0)
IMD19_by_LSOA$IMDQuintile  <- mapvalues(IMD19_by_LSOA$IMDDecil,
from = 1:10,
to = c(1,1,2,2,3,3,4,4,5,5))
#Population
pop_by_LSOA <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
dplyr::rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Population by age
pop_by_LSOA_ages <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4)
#New variables
pop_by_LSOA_ages$`pop_0to19` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==0):which(names(pop_by_LSOA_ages)==19)])
pop_by_LSOA_ages$`pop_20to29` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==20):which(names(pop_by_LSOA_ages)==29)])
pop_by_LSOA_ages$`pop_30to39` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==30):which(names(pop_by_LSOA_ages)==39)])
pop_by_LSOA_ages$`pop_40to49` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==40):which(names(pop_by_LSOA_ages)==49)])
pop_by_LSOA_ages$`pop_50to59` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==50):which(names(pop_by_LSOA_ages)==59)])
pop_by_LSOA_ages$`pop_60to69` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==60):which(names(pop_by_LSOA_ages)==69)])
pop_by_LSOA_ages$`pop_70to79` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==70):which(names(pop_by_LSOA_ages)==79)])
pop_by_LSOA_ages$`pop_80plus` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==80):which(names(pop_by_LSOA_ages)=="90+")])
#Reshape
pop_by_LSOA_ages <- select(pop_by_LSOA_ages,`LSOA Code`,starts_with("pop"))
pop_by_LSOA_ages <- gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages <- dplyr::rename(pop_by_LSOA_ages,LSOA11CD=`LSOA Code`)
#LSOA to CCG
LSOA_to_CCG <- fread(paste0(popdatadir,"Other data/","Lookups/LSOA_(2011)_to_Clinical_Commissioning_Groups_to_Sustainability_and_Transformation_Partnerships_(April_2020)_Lookup_in_England.csv"), header=TRUE, sep=",", check.names=T)
############################################################################
################### Deprivation distr. in Liverpool-Wirral #################
############################################################################
LiverpoolWirral <- filter(LSOA_to_CCG,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
#Merge in population
LiverpoolWirral <- left_join(LiverpoolWirral,pop_by_LSOA,by="LSOA11CD")
filter(LiverpoolWirral,is.na(pop19))
#Merge in deprivation
LiverpoolWirral <- left_join(LiverpoolWirral,select(IMD19_by_LSOA,lsoa11cd,IMDQuintile),
by=c("LSOA11CD"="lsoa11cd"))
filter(LiverpoolWirral,is.na(IMDQuintile))
LiverpoolWirral_depquint <- LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup() %>%
mutate(.,pop19_total=sum(LiverpoolWirral$pop19)) %>%
mutate(rate=pop19/pop19_total*100)
LiverpoolWirral_depquint
LiverpoolWirral.bis
LiverpoolWirral
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
detach(package:plyr)
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,readODS,
gmodels,DescTools,data.table,
tibble,pbapply,pbmcapply,here,
tidyverse,readxl)
#Clean up the global environment
rm(list = ls())
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#Deprivation by LSOA
IMD19_by_LSOA <- fread(paste0(popdatadir,"Other data/","IMD/LSOA/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).csv"), header=TRUE, sep=",", check.names=T) %>%
filter(.,IMDDecil!=0)
IMD19_by_LSOA$IMDQuintile  <- mapvalues(IMD19_by_LSOA$IMDDecil,
from = 1:10,
to = c(1,1,2,2,3,3,4,4,5,5))
#Population
pop_by_LSOA <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
dplyr::rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Population by age
pop_by_LSOA_ages <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4)
#New variables
pop_by_LSOA_ages$`pop_0to19` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==0):which(names(pop_by_LSOA_ages)==19)])
pop_by_LSOA_ages$`pop_20to29` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==20):which(names(pop_by_LSOA_ages)==29)])
pop_by_LSOA_ages$`pop_30to39` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==30):which(names(pop_by_LSOA_ages)==39)])
pop_by_LSOA_ages$`pop_40to49` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==40):which(names(pop_by_LSOA_ages)==49)])
pop_by_LSOA_ages$`pop_50to59` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==50):which(names(pop_by_LSOA_ages)==59)])
pop_by_LSOA_ages$`pop_60to69` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==60):which(names(pop_by_LSOA_ages)==69)])
pop_by_LSOA_ages$`pop_70to79` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==70):which(names(pop_by_LSOA_ages)==79)])
pop_by_LSOA_ages$`pop_80plus` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==80):which(names(pop_by_LSOA_ages)=="90+")])
#Reshape
pop_by_LSOA_ages <- select(pop_by_LSOA_ages,`LSOA Code`,starts_with("pop"))
pop_by_LSOA_ages <- gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages <- dplyr::rename(pop_by_LSOA_ages,LSOA11CD=`LSOA Code`)
#LSOA to CCG
LSOA_to_CCG <- fread(paste0(popdatadir,"Other data/","Lookups/LSOA_(2011)_to_Clinical_Commissioning_Groups_to_Sustainability_and_Transformation_Partnerships_(April_2020)_Lookup_in_England.csv"), header=TRUE, sep=",", check.names=T)
############################################################################
################### Deprivation distr. in Liverpool-Wirral #################
############################################################################
LiverpoolWirral <- filter(LSOA_to_CCG,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
#Merge in population
LiverpoolWirral <- left_join(LiverpoolWirral,pop_by_LSOA,by="LSOA11CD")
filter(LiverpoolWirral,is.na(pop19))
#Merge in deprivation
LiverpoolWirral <- left_join(LiverpoolWirral,select(IMD19_by_LSOA,lsoa11cd,IMDQuintile),
by=c("LSOA11CD"="lsoa11cd"))
filter(LiverpoolWirral,is.na(IMDQuintile))
#Descriptive statistics by quintile
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(plyr,dplyr,stringr,sp,ggplot2,readODS,
gmodels,DescTools,data.table,
tibble,pbapply,pbmcapply,here,
tidyverse,readxl)
#Clean up the global environment
rm(list = ls())
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
###################################################
################### IMPORT OPEN DATA ##############
###################################################
#Deprivation by LSOA
IMD19_by_LSOA <- fread(paste0(popdatadir,"Other data/","IMD/LSOA/Lower_Super_Output_Area_(LSOA)_IMD_2019__(OSGB1936).csv"), header=TRUE, sep=",", check.names=T) %>%
filter(.,IMDDecil!=0)
IMD19_by_LSOA$IMDQuintile  <- mapvalues(IMD19_by_LSOA$IMDDecil,
from = 1:10,
to = c(1,1,2,2,3,3,4,4,5,5))
#Population
pop_by_LSOA <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4) %>%
select(.,`LSOA Code`,`All Ages`) %>%
dplyr::rename(.,LSOA11CD=`LSOA Code`,pop19=`All Ages`)
#Population by age
pop_by_LSOA_ages <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/LSOA/sape22dt2mid2019lsoasyoaestimatesunformatted/SAPE22DT2-mid-2019-lsoa-syoa-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=4)
#New variables
pop_by_LSOA_ages$`pop_0to19` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==0):which(names(pop_by_LSOA_ages)==19)])
pop_by_LSOA_ages$`pop_20to29` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==20):which(names(pop_by_LSOA_ages)==29)])
pop_by_LSOA_ages$`pop_30to39` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==30):which(names(pop_by_LSOA_ages)==39)])
pop_by_LSOA_ages$`pop_40to49` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==40):which(names(pop_by_LSOA_ages)==49)])
pop_by_LSOA_ages$`pop_50to59` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==50):which(names(pop_by_LSOA_ages)==59)])
pop_by_LSOA_ages$`pop_60to69` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==60):which(names(pop_by_LSOA_ages)==69)])
pop_by_LSOA_ages$`pop_70to79` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==70):which(names(pop_by_LSOA_ages)==79)])
pop_by_LSOA_ages$`pop_80plus` <- rowSums(pop_by_LSOA_ages[,which(names(pop_by_LSOA_ages)==80):which(names(pop_by_LSOA_ages)=="90+")])
#Reshape
pop_by_LSOA_ages <- select(pop_by_LSOA_ages,`LSOA Code`,starts_with("pop"))
pop_by_LSOA_ages <- gather(pop_by_LSOA_ages, ageband, count, pop_0to19:pop_80plus, factor_key=TRUE)
pop_by_LSOA_ages$ageband <- str_replace_all(pop_by_LSOA_ages$ageband,"pop_","")
pop_by_LSOA_ages <- dplyr::rename(pop_by_LSOA_ages,LSOA11CD=`LSOA Code`)
#LSOA to CCG
LSOA_to_CCG <- fread(paste0(popdatadir,"Other data/","Lookups/LSOA_(2011)_to_Clinical_Commissioning_Groups_to_Sustainability_and_Transformation_Partnerships_(April_2020)_Lookup_in_England.csv"), header=TRUE, sep=",", check.names=T)
############################################################################
################### Deprivation distr. in Liverpool-Wirral #################
############################################################################
LiverpoolWirral <- filter(LSOA_to_CCG,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
#Merge in population
LiverpoolWirral <- left_join(LiverpoolWirral,pop_by_LSOA,by="LSOA11CD")
filter(LiverpoolWirral,is.na(pop19))
#Merge in deprivation
LiverpoolWirral <- left_join(LiverpoolWirral,select(IMD19_by_LSOA,lsoa11cd,IMDQuintile),
by=c("LSOA11CD"="lsoa11cd"))
filter(LiverpoolWirral,is.na(IMDQuintile))
detach(package:plyr)
LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup()
LiverpoolWirral_depquint <- LiverpoolWirral %>%
group_by(.,IMDQuintile) %>%
summarise(.,pop19 = sum(pop19)) %>%
ungroup() %>%
mutate(.,pop19_total=sum(LiverpoolWirral$pop19)) %>%
mutate(rate=pop19/pop19_total*100)
LiverpoolWirral_depquint
#Start with population, merge in CCG indicators
LiverpoolWirral.bis <- left_join(pop_by_LSOA_ages,select(LSOA_to_CCG,"LSOA11CD","CCG20NM"),by="LSOA11CD") %>%
filter(.,CCG20NM %in% c("NHS Liverpool CCG","NHS Wirral CCG"))
#Merge in deprivation
LiverpoolWirral.bis <- left_join(LiverpoolWirral.bis,select(IMD19_by_LSOA,"lsoa11cd","IMDQuintile"),
by=c("LSOA11CD"="lsoa11cd"))
LiverpoolWirral.bis
LiverpoolWirral.bis %>%
group_by(.,IMDQuintile,ageband) %>%
summarise(.,pop19 = sum(count)) %>%
ungroup()
LiverpoolWirral.bis %>%
group_by(.,ageband) %>%
summarise(.,agetotals = sum(count))
LiverpoolWirral.bis.totals.age <-  LiverpoolWirral.bis %>%
group_by(.,ageband) %>%
summarise(.,agetotals = sum(count))
LiverpoolWirral.bis.dep.age <-  LiverpoolWirral.bis %>%
group_by(.,IMDQuintile) %>%
summarise(.,deptotals = sum(count))
LiverpoolWirral.bis.dep.age
LiverpoolWirral.bis.totals.age
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint <- LiverpoolWirral.bis %>%
group_by(.,IMDQuintile,ageband) %>%
summarise(.,pop19 = sum(count)) %>%
ungroup()
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint
LiverpoolWirral.bis.totals.age
left_join(LiverpoolWirral_agedepquint,
LiverpoolWirral.bis.totals.age,by="ageband")
LiverpoolWirral.bis.totals.dep <-  LiverpoolWirral.bis %>%
group_by(.,IMDQuintile) %>%
summarise(.,deptotals = sum(count))
LiverpoolWirral.bis.totals.dep
left_join(LiverpoolWirral_agedepquint,
LiverpoolWirral.bis.totals.age,by="ageband") %>%
left_join(.,LiverpoolWirral.bis.totals.dep,by="IMDQuintile")
LiverpoolWirral_agedepquint
sum(LiverpoolWirral_agedepquint$pop19)
LiverpoolWirral_agedepquint <- LiverpoolWirral_agedepquint %>%
mutate(.,rate_over_age=pop19/agetotals*100) %>%
mutate(.,rate_over_dep=pop19/deptotals*100)
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint <- left_join(LiverpoolWirral_agedepquint,
LiverpoolWirral.bis.totals.age,by="ageband") %>%
left_join(.,LiverpoolWirral.bis.totals.dep,by="IMDQuintile")
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint <- LiverpoolWirral_agedepquint %>%
mutate(.,rate_over_age=pop19/agetotals*100) %>%
mutate(.,rate_over_dep=pop19/deptotals*100)
LiverpoolWirral_agedepquint
knitr::opts_chunk$set(echo = TRUE)
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,plyr,readODS,
gmodels,Rmisc,DescTools,data.table,
Hmisc,tibble,leaflet,rgeos,raster,plotly,
pbapply,pbmcapply,here,rgdal,RColorBrewer,ggthemes,
ggchicklet,tidyverse,showtext,ggchicklet,readxl)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
age_imd_data_full <- filter(allpartners.demographics.clean,Breakdown_Field=="age_band_imd") %>%
filter(.,var1.level %in% c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+"))
cols6 <- c(brewer.pal(n = 5, name = "RdYlGn"),"#bdbdbd")
imd_age_chart <- ggplot(age_imd_data_full,
aes(x=factor(var1.level),
y = round(interaction_rate_v1,1),
fill=factor(var2.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 10),
axis.text = element_text(size = 10),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_fill_manual(values=cols6) +
guides(fill=guide_legend(title="IMD/SIMD quintile"))
ggplotly(imd_age_chart)
LiverpoolWirral_agedepquint
filter(LiverpoolWirral_agedepquint,ageband=="80plus")
sum(filter(LiverpoolWirral_agedepquint,ageband=="80plus")$rate_over_age)
fwrite(LiverpoolWirral_agedepquint, file = paste0(rawdatadir,"opendata-demographics-interactions.csv"), sep = ",")
#Clean up the global environment
rm(list = ls())
#Git directory
gitdir <- dirname(rstudioapi::getSourceEditorContext()$path)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
##################################################
################### Load clean data ##############
##################################################
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint <- fread(paste0(rawdatadir,"opendata-demographics-interactions.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint
age_imd_data_full
age_imd_data_full <- filter(allpartners.demographics.clean,Breakdown_Field=="age_band_imd") %>%
filter(.,var1.level %in% c("0-19","20-29","30-39","40-49","50-59","60-69","70-79","80+"))
age_imd_data_full
opendata_comparison_bis <- filter(age_imd_data_full,Partner=="LiverpoolWirral")
opendata_comparison_bis
age_imd_data_full
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint$ageband <- str_replace_all(LiverpoolWirral_agedepquint$ageband,"to","-")
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint$ageband <- str_replace_all(LiverpoolWirral_agedepquint$ageband,"plus","+")
LiverpoolWirral_agedepquint
opendata_comparison_bis
LiverpoolWirral_agedepquint
LiverpoolWirral_agedepquint <- dplyr::rename(LiverpoolWirral_agedepquint,
var1.level=ageband,
var2.level=IMDQuintile,
interaction_rate_v1=rate_over_age)
LiverpoolWirral_agedepquint
opendata_comparison_bis <- rbind.fill(opendata_comparison_bis,LiverpoolWirral_agedepquint)
opendata_comparison_bis
LiverpoolWirral_agedepquint$Partner <- "LiverpoolWirral-ONS"
LiverpoolWirral_agedepquint
opendata_comparison_bis <- rbind.fill(opendata_comparison_bis,LiverpoolWirral_agedepquint)
opendata_comparison_bis <- filter(age_imd_data_full,Partner=="LiverpoolWirral")
opendata_comparison_bis <- rbind.fill(opendata_comparison_bis,LiverpoolWirral_agedepquint)
filter(opendata_comparison_bis,var1.level=="80+")
ggplot(opendata_comparison_bis,
aes(x=factor(var1.level),
y = interaction_rate_v1,
fill=factor(var2.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols6,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD quintile"))
cols6 <- c(brewer.pal(n = 5, name = "RdYlGn"),"#bdbdbd")
age_dep_open <- ggplot(opendata_comparison_bis,
aes(x=factor(var1.level),
y = interaction_rate_v1,
fill=factor(var2.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 30),
axis.text = element_text(size = 30),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_colour_manual(
values = cols6,
aesthetics = c("colour", "fill")) +
guides(fill=guide_legend(title="IMD quintile"))
windows()
age_dep_open
#Prepate data for comparions
opendata_comparison_bis <- filter(age_imd_data_full,Partner=="LiverpoolWirral")
#Change naming conventions
LiverpoolWirral_agedepquint$ageband <- str_replace_all(LiverpoolWirral_agedepquint$ageband,"to","-")
LiverpoolWirral_agedepquint$ageband <- str_replace_all(LiverpoolWirral_agedepquint$ageband,"plus","+")
LiverpoolWirral_agedepquint <- dplyr::rename(LiverpoolWirral_agedepquint,
var1.level=ageband,
var2.level=IMDQuintile,
interaction_rate_v1=rate_over_age)
knitr::opts_chunk$set(echo = TRUE)
#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,stringr,sp,ggplot2,plyr,readODS,
gmodels,Rmisc,DescTools,data.table,
Hmisc,tibble,leaflet,rgeos,raster,plotly,
pbapply,pbmcapply,here,rgdal,RColorBrewer,ggthemes,
ggchicklet,tidyverse,showtext,ggchicklet,readxl)
#Set directory where inputs are saved
rawdatadir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/"
opendatadir <- "M:/Analytics/Networked Data Lab/COVID19_Shielding/"
popdatadir <- "M:/Analytics/Networked Data Lab/Shielding/"
graphsdir <- "M:/Analytics/Networked Data Lab/Partner outputs/Output 1 Demographics/Charts/"
#Partner data
allpartners.demographics.clean <- fread(paste0(rawdatadir,"allpartners-demographics-clean.csv"), header=TRUE, sep=",", check.names=T)
#Population data
pop_by_LA <- fread(paste0(opendatadir,"Clean data/","pop_by_LA.csv"), header=TRUE, sep=",", check.names=T)
pop_by_CCG <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/CCG/sape22dt6amid2019ccg2020estimatesunformatted/","SAPE22DT6a-mid-2019-ccg-2020-estimates-unformatted.xlsx"),
sheet = "Mid-2019 Persons",skip=6) %>% filter(.,!is.na(`CCG Code`))
pop_by_scottish_board <- read_excel(paste0(popdatadir,"Other data/Mid-year population estimates/Scotland/","mid-year-pop-est-19-data.xlsx"),
sheet = "Table 2",range="A40:CQ54")
#Other open data (SPL)
SPL_by_LA_dgroup_dep <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup_dep.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_dgroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_dgroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_agegroup <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_agegroup.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_All_incl_ENG <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_All_incl_ENG.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_Wales_All <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_Wales_All.csv"), header=TRUE, sep=",", check.names=T)
SPL_by_LA_gender <- fread(paste0(opendatadir,"Clean data/","SPL_by_LA_gender.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (SPL by CCG)
SPL_by_CCG <- fread(paste0(popdatadir,"SPL/England/November/","Coronavirus Shielded Patient List, England - Open Data with CMO DG - CCG - 2020-11-06 v2.csv"), header=TRUE, sep=",", check.names=T)
#Other open data (summary tables)
SPL_by_GOR_wEng <- fread(paste0(graphsdir,"SPL_by_GOR_wEng (October).csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_depquint <- fread(paste0(rawdatadir,"opendata-demographics.csv"), header=TRUE, sep=",", check.names=T)
LiverpoolWirral_agedepquint <- fread(paste0(rawdatadir,"opendata-demographics-interactions.csv"), header=TRUE, sep=",", check.names=T)
#Prepate data for comparions
opendata_comparison_bis <- filter(age_imd_data_full,Partner=="LiverpoolWirral")
#Change naming conventions
LiverpoolWirral_agedepquint$ageband <- str_replace_all(LiverpoolWirral_agedepquint$ageband,"to","-")
LiverpoolWirral_agedepquint$ageband <- str_replace_all(LiverpoolWirral_agedepquint$ageband,"plus","+")
LiverpoolWirral_agedepquint <- dplyr::rename(LiverpoolWirral_agedepquint,
var1.level=ageband,
var2.level=IMDQuintile,
interaction_rate_v1=rate_over_age)
LiverpoolWirral_agedepquint$Partner <- "LiverpoolWirral-ONS"
#Append datasets
opendata_comparison_bis <- rbind.fill(opendata_comparison_bis,LiverpoolWirral_agedepquint)
#Chart
cols6 <- c(brewer.pal(n = 5, name = "RdYlGn"),"#bdbdbd")
age_dep_open <- ggplot(opendata_comparison_bis,
aes(x=factor(var1.level),
y = interaction_rate_v1,
fill=factor(var2.level))) +
facet_wrap(~ Partner) +
geom_bar(stat="identity",position="dodge") +
theme(panel.border = element_blank(),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(),axis.text.y=element_blank(),
axis.ticks.y=element_blank(),axis.ticks.x=element_blank(),
text = element_text(size = 10),
axis.text = element_text(size = 10),
axis.title.x = element_text(margin = unit(c(3, 0, 0, 0), "mm"))) +
labs(title=" ",y = " ",x="Age group") +
scale_fill_manual(values=cols6) +
guides(fill=guide_legend(title="IMD quintile"))
ggplotly(age_dep_open)
